
@{
    Layout = null;

}

@model Web.Portal.Model.Models.HermesInvoice
<form class="form-horizontal" id="frmAction">
    <div class="row">
        <input type="hidden" id="InvoiceIns" name="keyValue" value="@Html.DisplayFor(model=>model.ID)" />
        <div class="form-group form-md-line-input">
            <label class="col-md-2 control-label" for="frmAction">
                <b>KHÁCH HÀNG:</b>
                <span class="required">*</span>
            </label>
            <div class="col-md-10">
                <input class="form-control form-control-inline input txtName" id="txtName" placeholder="khách hàng" maxlength="256" data-id="@Html.DisplayTextFor(model=>model.KundName)" value="@Html.DisplayTextFor(model=>model.KundName)" name="kundName" />
                <div class="form-control-focus"> </div>
                <span class="help-block">NHẬP KHÁCH HÀNG</span>
            </div>
        </div>
        <div class="form-group form-md-line-input">
            <label class="col-md-2 control-label" for="frmAction">
                <b>ĐỊA CHỈ:</b>
                <span class="required">*</span>
            </label>
            <div class="col-md-10">
                <input class="form-control form-control-inline input txtName" id="txtAddress" placeholder="địa chỉ" maxlength="256" data-id="@Html.DisplayTextFor(model=>model.Address)" value="@Html.DisplayTextFor(model=>model.Address)" name="address" />
                <div class="form-control-focus"> </div>
                <span class="help-block">NHẬP ĐỊA CHỈ</span>
            </div>
        </div>
        <div class="form-group form-md-line-input">
            <label class="col-md-2 control-label" for="frmAction">
                <b>MÃ SỐ THUẾ:</b>
                <span class="required">*</span>
            </label>
            <div class="col-md-10">
                <input class="form-control form-control-inline input txtName" id="txtMST" placeholder="MST" maxlength="256" data-id="@Html.DisplayTextFor(model=>model.TaxCode)" value="@Html.DisplayTextFor(model=>model.TaxCode)" name="taxcode" />
                <div class="form-control-focus"> </div>
                <span class="help-block">NHẬP MÃ SỐ THUẾ</span>
            </div>
        </div>
        <div class="form-group form-md-line-input">
            <label class="col-md-2 control-label" for="frmAction">
                <b>SỐ VẬN ĐƠN:</b>
                <span class="required">*</span>
            </label>
            <div class="col-md-10">
                <input class="form-control form-control-inline input txtName" id="txtAWB" placeholder="số vận đơn" maxlength="256" data-id="@Html.DisplayTextFor(model=>model.AWB)" value="@Html.DisplayTextFor(model=>model.AWB)" name="awb" />
                <div class="form-control-focus"> </div>
                <span class="help-block">NHẬP SỐ VẬN ĐƠN</span>
            </div>
        </div>
        <div class="form-group form-md-line-input">
            <label class="col-md-2 control-label" for="frmAction">
                <b>SỐ HAWB:</b>
                <span class="required">*</span>
            </label>
            <div class="col-md-10">
                <input class="form-control form-control-inline input txtName" id="txtHawb" placeholder="số hawb" maxlength="256" data-id="@Html.DisplayTextFor(model=>model.Hawb)" value="@Html.DisplayTextFor(model=>model.Hawb)" name="hawb" />
                <div class="form-control-focus"> </div>
                <span class="help-block">NHẬP SỐ HAWB</span>
            </div>
        </div>
        <div class="form-group form-md-line-input">
            <label class="col-md-2 control-label" for="frmAction">
                <b>EMAIL:</b>
                <span class="required">*</span>
            </label>
            <div class="col-md-10">
                <input class="form-control form-control-inline input txtName" id="txtEmail" placeholder="Danh sách Email ngăn cách bởi dấu ; " maxlength="256" data-id="@Html.DisplayTextFor(model=>model.Email)" value="@Html.DisplayTextFor(model=>model.Email)" name="email" />
                <div class="form-control-focus"> </div>
                <span class="help-block">NHẬP EMAIL</span>
            </div>
        </div>
        <div class="form-group form-md-line-input">

            <label class="col-md-2 control-label" for="frmAction">
                <b>Ghi chú:</b>

            </label>
            <div class="col-md-10">
                <textarea rows="2" cols="10" class="form-control" id="txtNote" placeholder="Ghi chú khác" name="note"></textarea>
                <div class="form-control-focus"> </div>
                <span class="help-block">Nhập ghi chú khác</span>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <table class="table table-striped table-hover">
                <thead style="font-size:14px">
                    <tr class="step1">
                        <th style="width:25%">Tên dịch vụ</th>
                        <th style="width:5%">DVT</th>
                        <th style="width:15%" class="align-right">Số lượng</th>
                        <th style="width:15%" class="align-right">Đơn giá</th>
                        <th style="width:15%" class="align-right">Thành tiền</th>
                        <th style="width:5%" class="align-left">Thuế suất</th>
                        <th style="width:10%" class="align-left">Tiền Thuế GTGT</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="cartBody"></tbody>
            </table>
            <script id="tplCart" type="x-tmpl-mustache">
                <tr id="{{ItemId}}">
                    <td>
                        <div id="tooltip-inventory-${itemIndex}" class="left position-relative">
                           {{Item}}
                        </div>
                    </td>
                    <td>
                        <div id="tooltip-inventory-${itemIndex}" class="left position-relative">
                            <span>{{Unit}}</span>
                        </div>
                    </td>
                    <td>
                        <div class="input-wrap">
                            <input step=".01" autocomplete="off" class="txtQuantity quantity-input sapo-textbox align-right" type="number" min="1" max="100"
                                   data-id="{{ItemId}}"  data-price="{{Price}}" value="{{Quantity}}" style="width:60px;height:31px;border:1px solid #c4cdd5;border-radius:3px !important" />
                        </div>
                    </td>


                    <td class="align-right">
                        <div class="input-wrap">
                            <input step=".01" autocomplete="off" class="txtUnitPrice unitprice-input sapo-textbox align-right" type="number" min="1" max="100" data-id="{{ItemId}}"
                                   data-quantity="{{Quantity}}" value="{{Price}}" style="width:100px;height:31px;border:1px solid #c4cdd5;border-radius:3px !important" />
                        </div>
                    </td>
                    <td class="align-right" id="amount_{{ItemId}}">
                        <span>{{Amount}}</span>
                    </td>
                    <td>
                        <div class="input-wrap">
                            <span>{{Tax}}</span>
                        </div>
                    </td>
                    <td>
                        <div class="input-wrap">
                            <span>{{VAT}}</span>
                        </div>
                    </td>
                    
                </tr>
            </script>
            <div class="col-md-12 no-padding">
                <a href="javascript:" bind-event-click="addLineItemFreeform()" id="btnAddService" class="btn-add-freeform">
                    <i class="fa fa-plus green-sapo pr-1"></i>Thêm dịch vụ khác (F9)
                </a>

            </div>
            <div class="row">
                <div class="form-group form-md-line-input no-padding" style="padding:0">
                    <label class="label col-md-10 control-label" style="color:black;padding-top:10px">
                        <b class="pull-right">Tổng tiền (<span></span> Chưa VAT):</b>
                    </label>
                    <div class="value col-md-2" style="color:black;">
                        <label class="control-label" for="frmAction">
                            <b style="color:red"> @Model.InvoiceTotalNoVatAmount</b>
                        </label>
                    </div>
                </div>
                <div class="form-group form-md-line-input no-padding" style="padding:0">
                    <label class="label col-md-10 control-label" style="color:black;padding-top:10px">
                        <b class="pull-right">VAT(10%):</b>
                    </label>
                    <div class="value col-md-2" style="color:black;">
                        <label class="control-label" for="frmAction">
                            <b style="color:red"> @Model.InvoiceTotalVatAmount</b>
                        </label>
                    </div>
                </div>
                <div class="form-group form-md-line-input no-padding" style="padding:0">
                    <label class="label col-md-10 control-label" style="color:black;padding-top:10px">
                        <b class="pull-right">Khách phải trả:</b>
                    </label>
                    <div class="value col-md-2" style="color:black;">
                        <label class="control-label" for="frmAction">
                            <b style="color:red"> @Model.InvoiceTotalAmount</b>
                        </label>
                    </div>
                </div>
            </div>


        </div>

    </div>
    <div class="text-center">
        <button type="submit" data-loading-text="Loading..." class="demo-loading-btn btn btn-success" id="btnSave"><i class="fa fa-floppy-o"></i>GỬI LẠI</button>
        @*<button type="reset" class="btn btn-success"><i class="fa fa-refresh"></i> Làm mới</button>*@
    </div>
</form>
    <script>
        var cartAdmin = {
            init: function () {
                cartAdmin.loadData();
                cartAdmin.registerEvent();
            },
            registerEvent: function () {
                $('#btnSave').off('click').on('click', function (e) {
                    $(this).prop('disabled', true);
                    e.preventDefault();
                    cartAdmin.SaveAndSend();

                });
             
            },
            SaveAndSend: function () {
                var cartList = [];
                $('#cartBody > tr').each(function() {
                    trid = $(this).attr('id'); // table row ID 
                    var value = $(this).find('input').val();
                    var price = $(this).find('input').eq(1).val();
                    console.log(trid);
                    cartList.push({
                        ID: trid,
                        Quantity: value,
                        UnitPrice:price,
                    });
                })
                var id = @Model.ID;
                var order = {
                    ID : id,
                    KundName: $('#txtName').val(),
                    Address: $('#txtAddress').val(),
                    TaxCode: $('#txtMST').val(),
                    AWB: $('#txtAWB').val(),
                    Hawb: $("#txtHawb").val(),
                    Email: $('#txtEmail').val(),
                    Note: $('#txtNote').val(),
                    InvoiceDetailViewModels: cartList
                }
                $.ajax({
                    url: '/einvoice/SaveEdit',
                    type: 'POST',
                    data: {
                        order: JSON.stringify(order)
                    },
                    dataType: 'json',
                    success: function (response) {
                        if (response.status) {
                            window.open("/einvoice/Reprint?invoiceins=" + response.data);
                        }
                        else {
                            egovutil.MessageToast("error", "Thông báo", response.data);
                        }
                    }
                });
             
            },
            loadData: function () {
                $.ajax({
                    url: '/einvoice/getall',
                    type: 'GET',
                    dataType: 'json',
                    success: function (res) {
                        if (res.status) {
                            var html = '';
                            var template = $('#tplCart').html();
                            var data = res.data;
                            $.each(data, function (i, item) {
                                html += Mustache.render(template, {
                                    ItemId: item.ID,
                                    Item: item.Item,
                                    VAT: item.VAT,
                                    Unit: item.Unit,
                                    Price: item.UnitPrice,
                                    Quantity: item.Quantity,
                                    Tax: item.Tax,
                                    Amount: item.Amount
                                    // Amount: modeSale == 1 ? (item.Quantity * (item.Product.Price - item.Discount)) : (item.Quantity * (item.Product.WholePrice - item.Discount))
                                });
                            });

                            $('#cartBody').html(html);
                            cartAdmin.registerEvent();
                        }
                    }
                })
            }
        }
        cartAdmin.init();
    </script>
